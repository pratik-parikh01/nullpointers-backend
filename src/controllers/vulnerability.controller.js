const { Projects, Vulnerabilities } = require("../models");
const { generateUniqueSlug } = require("../common.utils");

// Add a new project with vulnerability list
exports.addVulnerability = async (req, res) => {
  try {
    console.log("addVulnerability :: body", {
      body: req.body,
    });

    const paylaod = {
      name: req.body.project,
      slug: generateUniqueSlug(req.body.project),
      description: "",
      path: req.body.branch,
      organization: req.body.organization || "nullpointers",
      branch: req.body.branch,
      lastModifiedDate: new Date(),
      meta: {
        ...(req.body || {})
      }
    };
    delete paylaod.meta.Results
    const vulnerabilitiesList = req.body.Results || []

    // First, create or find the project
    const project = await Projects.findOneAndUpdate(
      { name: paylaod.name },
      { ...paylaod },
      { upsert: true, new: true }
    );

    const result = [];

    for(let vulnerabilityityData of (vulnerabilitiesList || [])) {
      const vulResponse = await Vulnerabilities.create({
        projectId: project._id,
        branch: req.body.branch,
        commit: req.body.commit,
        PR_link: req.body.pr || "",
        tags: req.body.tags || [],
        vulnerabilityList: vulnerabilityityData
      });

      result.push(vulResponse);
    }

    res.status(201).json({
      data: { project, result },
      message: "Data stored successfully",
    });
  } catch (error) {
    console.error("Error in addVulnerability:", error);
    res.status(400).json({ error: error.message });
  }
};
